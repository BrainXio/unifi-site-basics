name: Terraform / OpenTofu Basics

on:
  push:
    branches:
      - main
      - next
  pull_request:
    branches:
      - main
      - next

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-tf-files:
    runs-on: ubuntu-latest
    name: Check for Terraform files
    outputs:
      has_tf_files: ${{ steps.check.outputs.has_tf_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Detect .tf / .tofu files
        id: check
        run: |
          if find . -type f \( -name "*.tf" -o -name "*.tofu" \) -not -path "./.git/*" -print -quit | grep -q .; then
            echo "has_tf_files=true" >> "$GITHUB_OUTPUT"
            echo "Terraform/OpenTofu files found → proceeding"
          else
            echo "has_tf_files=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No .tf or .tofu files found → skipping checks"
          fi

  fmt:
    needs: detect-tf-files
    if: ${{ needs.detect-tf-files.outputs.has_tf_files == 'true' }}
    runs-on: ubuntu-latest
    name: Format Check
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '~1.11.0'
          tofu_wrapper: false

      - name: Check formatting
        run: tofu fmt -check

  validate:
    needs: detect-tf-files
    if: ${{ needs.detect-tf-files.outputs.has_tf_files == 'true' }}
    runs-on: ubuntu-latest
    name: Validate Configuration
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '~1.11.0'
          tofu_wrapper: false

      - name: Initialize (no backend)
        run: tofu init -backend=false

      - name: Validate
        run: tofu validate

  pr-comment:
    needs: [detect-tf-files, fmt, validate]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: PR Comment
    steps:
      - name: Find existing comment
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'OpenTofu/Terraform Validation Status'

      # ── Case 1: No .tf files ───────────────────────────────────────────────
      - name: Comment - No .tf files
        if: needs.detect-tf-files.outputs.has_tf_files == 'false'
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### OpenTofu/Terraform Validation Status

            **No `.tf` or `.tofu` files detected in this PR.**

            No formatting or validation checks were run.
            If this is unexpected, verify file names and commits.

            *Triggered by @${{ github.actor }}*
          edit-mode: replace
          reactions: eyes

      - name: Post/Update comment - All checks passed
        if: >-
          needs.detect-tf-files.outputs.has_tf_files == 'true' && needs.fmt.result == 'success' && needs.validate.result == 'success'
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### OpenTofu/Terraform Validation Status ✅

            **All checks passed!**

            - `tofu fmt -check`: Passed
            - `tofu validate`: Passed

            Configuration looks good.

            *Triggered by @${{ github.actor }}*
          edit-mode: replace
          reactions: rocket

      - name: Post/Update comment - One or more checks failed
        if: >-
          needs.detect-tf-files.outputs.has_tf_files == 'true' && (needs.fmt.result != 'success' || needs.validate.result != 'success')
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### OpenTofu/Terraform Validation Status ❌

            **One or more checks failed.**

            - **Format check** (`tofu fmt -check`): ${{ needs.fmt.result == 'success' && 'Passed' || 'Failed' }}
            - **Validation** (`tofu validate`): ${{ needs.validate.result == 'success' && 'Passed' || 'Failed' }}

            Check the workflow logs for details.

            *Triggered by @${{ github.actor }}*
          edit-mode: replace
          reactions: confused

  generate-docs:
    needs: detect-tf-files
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/next' && needs.detect-tf-files.outputs.has_tf_files == 'true' }}
    runs-on: ubuntu-latest
    name: Generate & Commit README Docs
    permissions:
      contents: write
    steps:
      - name: Checkout next branch (full history)
        uses: actions/checkout@v6
        with:
          ref: next
          fetch-depth: 0

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '~1.11.0'
          tofu_wrapper: false

      - name: Install terraform-docs
        run: |
          TERRAFORM_DOCS_VERSION="v0.20.0"
          curl -sSL https://github.com/terraform-docs/terraform-docs/releases/download/${TERRAFORM_DOCS_VERSION}/terraform-docs-${TERRAFORM_DOCS_VERSION}-linux-amd64.tar.gz | \
            tar -xz terraform-docs
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/
          terraform-docs --version

      - name: Generate docs with site-docs.sh
        run: ./scripts/site-docs.sh --make
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}

      - name: Commit and push if docs changed
        run: |-
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md site/
          if git diff --staged --quiet; then
            echo "No documentation changes detected"
          else
            git commit -m "chore(docs): auto-update README with latest terraform-docs [ci skip]"
            git push origin HEAD:next
            echo "README/docs committed and pushed to next"
          fi
